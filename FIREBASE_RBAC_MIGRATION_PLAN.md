# Firebase Integration & RBAC Migration Plan

**Date:** 2026-02-04
**Status:** DRAFT
**Context:** Migration from `mock_db.json` / `mock_firestore.py` to production Firebase Firestore & Authentication.

## 1. Executive Summary

This plan outlines the steps to migrate the AURA-NOTES-MANAGER from a mock file-based database to a production-ready Firebase Firestore backend with robust Role-Based Access Control (RBAC).

**Current State:**
- **Auth:** Mock tokens (`mock-token-admin...`) generated by `POST /api/auth/login`.
- **DB:** In-memory dictionary loaded from `mock_db.json`.
- **RBAC:** Logic exists in `api/auth.py` but relies on mock data.

**Target State:**
- **Auth:** Client-side login via Firebase JS SDK. Backend verifies real ID Tokens.
- **DB:** Google Cloud Firestore (NoSQL).
- **RBAC:** Hybrid model using **Firestore Documents** for granular permissions (subjects/departments) and **Custom Claims** (optional, for optimization) for high-level roles (`admin`, `staff`, `student`).

---

## 2. Architecture & Schema Design

### 2.1. User Schema (Firestore)

We will use a **Firestore Document-based RBAC** approach for flexibility, as the "Staff" role requires complex relationships (`subject_ids`).

**Collection:** `users` (Root Level)
**Document ID:** `{uid}` (Matches Firebase Auth UID)

```json
{
  "uid": "string (PK)",
  "email": "string",
  "displayName": "string",
  "role": "enum('admin', 'staff', 'student')",
  "status": "enum('active', 'disabled')",
  "departmentId": "string (Reference to departments/{id}) - Required for Student",
  "subjectIds": ["string"] (Array of References to subjects/{id}) - Required for Staff,
  "createdAt": "timestamp",
  "updatedAt": "timestamp"
}
```

### 2.2. RBAC Policies

| Role | Dashboard Access | Users Mgmt | Department/Semester/Subject Mgmt | Module/Note Mgmt |
|---|---|---|---|---|
| **Admin** | Full Access | Full (Create/Edit/Delete) | Full (CRUD) | Full (CRUD) |
| **Staff** | Restricted | View Self | Read-Only (Assigned Dept) | Edit (Assigned Subjects Only) |
| **Student**| Read-Only | View Self | Read-Only (Assigned Dept) | Read-Only |

---

## 3. Implementation Phases

### Phase 1: Infrastructure & Configuration
**Goal:** Connect backend to real Firebase project.

1.  **Environment Setup**
    *   Ensure `GOOGLE_APPLICATION_CREDENTIALS` points to a Service Account with:
        *   `Firebase Admin SDK Administrator Service Agent`
        *   `Cloud Datastore User`
    *   Update `.env`:
        ```ini
        USE_REAL_FIREBASE=true
        FIREBASE_CREDENTIALS=./serviceAccountKey.json
        ```
2.  **Verify `api/config.py`**
    *   Confirm `init_firebase()` correctly loads the service account.
    *   Confirm `get_db()` switches logic based on `USE_REAL_FIREBASE`.

### Phase 2: Data Migration (Seeding)
**Goal:** Move `mock_db.json` data to Firestore so the app isn't empty.

1.  **Create Seeding Script** (`tools/seed_firestore.py`)
    *   Read `mock_db.json`.
    *   Parse the flat-path keys (e.g., `"departments/xyz/semesters/abc"`) into real Firestore collection/document calls.
    *   **Crucial:** Create the `users` collection first.
    *   **Crucial:** Create the hierarchy (Departments -> Semesters -> Subjects -> Modules -> Notes).
2.  **Execute Seed**
    *   Run `python tools/seed_firestore.py`.
    *   Verify data in Firebase Console.

### Phase 3: Frontend Authentication Refactor
**Goal:** Replace mock login with real Firebase Auth.

*Current Mock Flow:* Frontend sends POST to `/api/auth/login` with email/pass -> Backend returns mock token.
*New Real Flow:* Frontend uses SDK to login -> Gets Token -> Sends Token to Backend.

1.  **Install Firebase SDK (Frontend)**
    *   `cd frontend && npm install firebase`
2.  **Initialize Firebase**
    *   Create `frontend/src/lib/firebase.ts` with config (API Key, Auth Domain, Project ID).
3.  **Update Login Page (`frontend/src/pages/LoginPage.tsx`)**
    *   Replace `fetch('/api/auth/login')` with `signInWithEmailAndPassword(auth, email, password)`.
    *   Get ID Token: `const token = await user.getIdToken()`.
    *   Store token in `useAuthStore` (or `localStorage`).
4.  **Update API Client (`frontend/src/api/client.ts`)**
    *   Ensure all requests include `Authorization: Bearer <REAL_ID_TOKEN>`.
    *   Implement token refresh logic (optional for MVP, but recommended).

### Phase 4: Backend Logic Update
**Goal:** Enforce real security.

1.  **Refactor `api/auth.py`**
    *   Update `verify_firebase_token`:
        *   Remove the "mock-token" bypass (or strictly limit it to `pytest` execution environments).
        *   Ensure `auth.verify_id_token(token)` is called.
    *   Update `get_current_user`:
        *   Keep the Firestore lookup `db.collection("users").document(uid).get()`.
        *   This ensures we get the latest `role` and permissions from the DB, not just what's in the token.
2.  **Refactor `api/users.py`**
    *   Remove `POST /api/auth/login` (the mock endpoint). **Delete it entirely.**
    *   Ensure `create_user` (Admin function) creates the user in *both* Firebase Auth (for login) and Firestore (for metadata).

### Phase 5: Testing & Verification
**Goal:** Prove it works.

1.  **Unit Tests (`tests/test_rbac.py`)**
    *   Create tests that mock `verify_id_token` to return specific claims.
    *   Test `require_admin`, `require_staff` decorators.
    *   Test access denial (Student trying to delete a Department).
2.  **Integration Test**
    *   Manual: Log in as Admin -> Create Staff user.
    *   Log in as Staff -> Try to delete a Department (Should fail 403).
    *   Log in as Staff -> Try to add a Note to assigned Subject (Should pass 200).

---

## 4. Rollback Strategy
If migration fails, revert `.env` variable:
`USE_REAL_FIREBASE=false`
This immediately switches `api/config.py` back to `mock_firestore.py`.

## 5. Security Checklist
- [ ] Firestore Security Rules deployed (deny default, allow backend service account).
- [ ] Service Account Key not committed to Git (added to `.gitignore`).
- [ ] Frontend API Keys restricted to specific domains (in Google Cloud Console).
