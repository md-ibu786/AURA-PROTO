# Firebase RBAC Migration

**One-liner**: Migrate AURA-NOTES-MANAGER from mock authentication to production Firebase Firestore & Authentication with robust Role-Based Access Control.

## Problem

AURA-NOTES-MANAGER currently uses mock authentication (`mock_db.json` / `mock_firestore.py`) for local development. While functional for development, this cannot be deployed to production. The application needs real Firebase Authentication with proper ID token verification, production Firestore with security rules, and a hybrid RBAC model that scales.

## Current State

- **Auth:** Mock tokens (`mock-token-admin...`) generated by `POST /api/auth/login`
- **DB:** In-memory dictionary loaded from `mock_db.json`
- **RBAC:** Logic exists in `api/auth.py` but relies on mock data
- **Status:** Mock auth system complete (5 phases, 9 plans - all done)

## Target State

- **Auth:** Client-side login via Firebase JS SDK, backend verifies real ID Tokens
- **DB:** Google Cloud Firestore (NoSQL) with security rules
- **RBAC:** Hybrid model using:
  - **Custom Claims** for high-level roles (`admin`, `staff`, `student`)
  - **Firestore Documents** for granular permissions (`subjectIds`, `departmentId`)
- **Security:** Firebase App Check for request verification

## Success Criteria

How we know it worked:

- [ ] Users can log in with Firebase Authentication (real email/password)
- [ ] Backend verifies real Firebase ID tokens (not mock tokens)
- [ ] Firestore Security Rules enforce RBAC at database level
- [ ] Custom Claims contain user role, verified in both backend and Security Rules
- [ ] Staff can only access/edit their assigned subjects
- [ ] Students can only read their assigned department's content
- [ ] App Check prevents unauthorized API access
- [ ] Migration script successfully transfers mock_db.json data to Firestore
- [ ] Rollback to mock auth works if issues arise (`USE_REAL_FIREBASE=false`)

## Constraints

- Must preserve existing user roles: admin, staff, student
- Must be compatible with existing Firestore collection structure (departments/semesters/subjects/modules/notes)
- Must support rollback to mock auth for local development
- Custom Claims limited to 1KB - only store role, not all permissions
- Service account key must never be committed to git

## Out of Scope

What we're NOT building:

- OAuth/social login providers (Google, GitHub, etc.)
- Multi-factor authentication
- Password reset UI (can use Firebase's built-in email reset)
- Email verification flow
- User registration UI (admin-only user creation)
- Multi-tenancy (single organization for now)

## Research Sources

Best practices incorporated from:
- Firebase Official Documentation (Context7)
- 2025 RBAC patterns: Hybrid Custom Claims + Firestore Documents
- FastAPI + Firebase Admin SDK integration patterns
- React token management with `onIdTokenChanged()`
- BulkWriter for data migration
- App Check with reCAPTCHA Enterprise

## Reference Documents

- @FIREBASE_RBAC_MIGRATION_PLAN.md - Original migration plan
- @AUTHENTICATION_DOCUMENTATION.md - Mock auth specification
- @.planning/ROADMAP.md - Completed mock auth implementation
