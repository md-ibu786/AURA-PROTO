---
phase: 05-frontend-firebase-sdk
type: execute
---

<objective>
Implement automatic token refresh with onIdTokenChanged listener and update API client to attach Firebase ID tokens to all requests. Remove localStorage token persistence and use Firebase SDK's built-in token management.

Purpose: Ensure API requests always have valid Firebase ID tokens, handle token refreshes automatically, and eliminate manual token storage.
Output: Automatic token management with API client interceptors and proper auth state synchronization.
</objective>

<execution_context>
@~.config/.Opencode/skills/create-plans/workflows/execute-phase.md
@~.config/.Opencode/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/firebase-rbac-migration/BRIEF.md
@.planning/firebase-rbac-migration/ROADMAP.md
@frontend/src/stores/useAuthStore.ts
@frontend/src/api/client.ts
@frontend/src/api/firebaseClient.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update initAuthListener to use onIdTokenChanged</name>
  <files>frontend/src/stores/useAuthStore.ts</files>
  <action>
    Replace onAuthStateChanged with onIdTokenChanged in initAuthListener:
    
    1. Import onIdTokenChanged instead of onAuthStateChanged from 'firebase/auth'
    2. onIdTokenChanged fires on both auth state changes AND token refreshes
    3. Update the callback to handle both cases:
       - When user is present: setFirebaseUser and call refreshUser()
       - When user is null (signed out): clear state
    4. Remove or conditionalize the mock token restore logic behind VITE_USE_MOCK_AUTH flag
    5. Ensure the listener handles token refresh events properly
    
    IMPORTANT: onIdTokenChanged is preferred over onAuthStateChanged because it fires when Firebase automatically refreshes the ID token (every ~1 hour). This keeps the token fresh without manual intervention.
  </action>
  <verify>grep -n "onIdTokenChanged\|onAuthStateChanged" frontend/src/stores/useAuthStore.ts</verify>
  <done>onIdTokenChanged imported and used in initAuthListener, handles token refresh events</done>
</task>

<task type="auto">
  <name>Task 2: Update getIdToken to use Firebase user</name>
  <files>frontend/src/stores/useAuthStore.ts</files>
  <action>
    Update the getIdToken action:
    1. Check VITE_USE_MOCK_AUTH flag first
    2. If mock mode: return localStorage.getItem('mock_token')
    3. If Firebase mode: get firebaseUser from state and call getIdToken()
    4. Firebase's getIdToken() automatically refreshes if expired
    5. Add forceRefresh parameter support: getIdToken(forceRefresh?: boolean)
    6. Return null if no user or token can't be retrieved
    
    This ensures API calls always get fresh tokens.
  </action>
  <verify>grep -A5 "getIdToken.*async" frontend/src/stores/useAuthStore.ts</verify>
  <done>getIdToken uses Firebase user.getIdToken() with auto-refresh support</done>
</task>

<task type="auto">
  <name>Task 3: Create Firebase auth header interceptor</name>
  <files>frontend/src/api/client.ts</files>
  <action>
    Update client.ts to automatically attach Firebase ID token to all requests:
    
    1. Import { useAuthStore } from '../stores/useAuthStore'
    2. Create a getAuthHeader async function that:
       - Checks if we're in mock mode (VITE_USE_MOCK_AUTH)
       - If mock: returns { Authorization: `Bearer ${localStorage.getItem('mock_token')}` }
       - If Firebase: calls useAuthStore.getState().getIdToken() and returns { Authorization: `Bearer ${token}` }
    3. Update fetchApi to call getAuthHeader and merge headers
    4. Update fetchFormData similarly
    5. Handle case where token is null (unauthenticated request)
    
    IMPORTANT: Do NOT use Axios interceptors - the project uses native fetch. Instead, wrap the fetch calls to inject headers.
  </action>
  <verify>grep -n "getAuthHeader\|getIdToken\|Authorization" frontend/src/api/client.ts</verify>
  <done>API client automatically attaches Firebase ID token to all requests</done>
</task>

<task type="auto">
  <name>Task 4: Remove localStorage token persistence from refreshUser</name>
  <files>frontend/src/stores/useAuthStore.ts</files>
  <action>
    Update refreshUser to remove localStorage persistence in Firebase mode:
    1. Check VITE_USE_MOCK_AUTH at the start
    2. If mock mode: keep existing localStorage sync behavior
    3. If Firebase mode: remove the localStorage.setItem('mock_user', ...) call
    4. Firebase Auth handles its own persistence via IndexedDB
    5. The user object in state is the source of truth
    
    Also update the logout function to only clear localStorage if in mock mode.
  </action>
  <verify>grep -n "localStorage" frontend/src/stores/useAuthStore.ts</verify>
  <done>localStorage usage conditionalized behind VITE_USE_MOCK_AUTH, Firebase uses IndexedDB</done>
</task>

<task type="auto">
  <name>Task 5: Add token expiration handling to API client</name>
  <files>frontend/src/api/client.ts</files>
  <action>
    Enhance error handling in client.ts for 401 Unauthorized responses:
    1. If API returns 401, it may mean token expired
    2. In fetchApi catch block, check for 401 status
    3. If 401 and using Firebase mode:
       - Call useAuthStore.getState().getIdToken(true) to force refresh
       - Retry the request with new token (max 1 retry)
       - If still 401, throw error for logout
    4. Add proper error messages for auth failures
    
    This provides automatic token refresh on 401 errors as a fallback.
  </action>
  <verify>grep -n "401\|forceRefresh\|retry" frontend/src/api/client.ts</verify>
  <done>API client handles 401 by attempting token refresh and retry</done>
</task>

<task type="auto">
  <name>Task 6: Verify auth state persistence across page reloads</name>
  <files>frontend/src/stores/useAuthStore.ts, frontend/src/App.tsx or main.tsx</files>
  <action>
    Ensure auth state persists across page reloads:
    1. Check that initAuthListener is called in main.tsx or App.tsx on app start
    2. Verify onIdTokenChanged fires on initial load with cached user
    3. Firebase Auth persists sessions to IndexedDB by default
    4. The store should restore user state from Firebase on reload
    5. Update loading state to show loading indicator while Firebase initializes
    
    Find where initAuthListener is called and ensure it's working correctly.
  </action>
  <verify>grep -rn "initAuthListener" frontend/src/</verify>
  <done>initAuthListener called on app start, Firebase session persists across reloads</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Automatic token management with onIdTokenChanged and API interceptors
  </what-built>
  <how-to-verify>
    1. Run: cd frontend && npm run dev
    2. Login with Firebase credentials
    3. Navigate around the app - all API calls should succeed
    4. Open DevTools → Application → IndexedDB → firebaseLocalStorageDb
    5. Verify Firebase stores auth data (not localStorage)
    6. Reload the page - should auto-login without entering credentials
    7. Check Network tab - all /api requests should have Authorization header with Bearer token
    8. Wait ~1 hour or manually delete token to test auto-refresh (optional)
  </how-to-verify>
  <expected-result>
    - User stays logged in across page reloads
    - All API requests include Authorization: Bearer <token> header
    - No mock_token in localStorage (Firebase mode)
    - Firebase Auth data in IndexedDB
  </expected-result>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 7: Run build and verify no errors</name>
  <files>frontend/</files>
  <action>
    Run full build to catch any TypeScript or runtime errors:
    1. cd frontend
    2. npm run build
    3. Fix any TypeScript errors
    4. Run npm run lint and fix any issues
    
    Ensure all imports are correct and no unused variables remain.
  </action>
  <verify>cd frontend && npm run build 2>&1 | tail -20</verify>
  <done>Build passes without errors, no TypeScript issues</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] onIdTokenChanged used instead of onAuthStateChanged
- [ ] API client automatically attaches Firebase ID token to requests
- [ ] getIdToken returns fresh tokens (auto-refreshes if expired)
- [ ] No localStorage token storage in Firebase mode
- [ ] Auth state persists across page reloads via IndexedDB
- [ ] 401 responses trigger token refresh and retry
- [ ] npm run build passes without errors
- [ ] Manual testing confirms all API calls include Authorization header
</verification>

<success_criteria>
- All tasks completed
- Automatic token refresh working with onIdTokenChanged
- API client injects Bearer tokens on all requests
- Firebase Auth persistence via IndexedDB (not localStorage)
- 401 handling with retry logic
- Build passes, no TypeScript errors
- Phase 5 complete, ready for Phase 6: App Check & Security Hardening
</success_criteria>

<output>
After completion, create `.planning/firebase-rbac-migration/phases/05-frontend-firebase-sdk/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Token Management - Summary

**Automatic Firebase token management with API interceptors**

## Accomplishments
- Replaced onAuthStateChanged with onIdTokenChanged for token refresh events
- Updated API client to automatically attach Firebase ID tokens to all requests
- Removed localStorage token persistence in favor of Firebase's IndexedDB
- Implemented 401 handling with automatic token refresh and retry
- Added forceRefresh support to getIdToken for role changes

## Files Created/Modified
- `frontend/src/stores/useAuthStore.ts` - onIdTokenChanged listener, updated getIdToken
- `frontend/src/api/client.ts` - Automatic Authorization header injection, 401 retry logic

## Decisions Made
- **onIdTokenChanged vs onAuthStateChanged**: Use onIdTokenChanged to catch token refresh events (fires every ~1 hour)
- **Persistence**: Firebase Auth uses IndexedDB by default, removed redundant localStorage
- **401 handling**: Automatic retry with forceRefresh as fallback for edge cases
- **No Axios**: Project uses native fetch, so headers are injected via wrapper functions

## Issues Encountered
None

## Phase 5 Complete
All Firebase Auth integration tasks completed:
✅ Firebase SDK setup with App Check
✅ Real authentication flow (signInWithEmailAndPassword)
✅ Automatic token management and API interceptors

## Next Step
Ready for Phase 6: App Check & Security Hardening (06-01-PLAN.md)
</output>
