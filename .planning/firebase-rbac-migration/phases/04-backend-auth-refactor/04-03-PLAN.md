---
phase: 04-backend-auth-refactor
type: execute
---

<objective>
Remove mock authentication endpoints and finalize the backend authentication system for production deployment.

Purpose: Clean up temporary mock authentication code and ensure the backend is ready for production with real Firebase Authentication.
Output: Clean backend with only real Firebase authentication, updated configuration, and comprehensive documentation.
</objective>

<execution_context>
@~.config/.Opencode/skills/create-plans/workflows/execute-phase.md
@~.config/.Opencode/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/firebase-rbac-migration/BRIEF.md
@.planning/firebase-rbac-migration/ROADMAP.md
@FIREBASE_RBAC_MIGRATION_PLAN.md
@api/auth.py
@api/users.py
@api/auth_sync.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove mock login endpoint</name>
  <files>api/users.py</files>
  <action>
    Find and remove the mock login endpoint POST /api/auth/login.
    
    The mock login endpoint validates against mock_db.json and returns mock tokens.
    
    Steps:
    1. Read api/users.py to find the login endpoint
    2. Remove the entire endpoint function
    3. Remove associated request/response models
    4. Keep other user endpoints
    
    After removal verify the file still has user list, get, and other endpoints properly protected.
  </action>
  <verify>
    1. Confirm POST /api/auth/login is removed
    2. Verify other endpoints exist
    3. Run: python -c "from api.users import router; print('OK')"
  </verify>
  <done>Mock login endpoint removed</done>
</task>

<task type="auto">
  <name>Task 2: Isolate mock token verification</name>
  <files>api/auth.py</files>
  <action>
    Modify verify_firebase_token to only use mock tokens in test environment.
    
    Update logic:
    - Check both USE_REAL_FIREBASE and TESTING environment variables
    - Only use mock when TESTING=true AND USE_REAL_FIREBASE=false
    - Production always uses real Firebase
    
    This keeps mock available for unit tests but ensures production uses real auth.
  </action>
  <verify>
    1. Verify logic updated in api/auth.py
    2. Verify mock only used when TESTING=true
    3. Verify real Firebase used otherwise
  </verify>
  <done>Mock token verification isolated to test environment</done>
</task>

<task type="auto">
  <name>Task 3: Update environment configuration</name>
  <files>.env, .env.example</files>
  <action>
    Update environment files for production:
    
    .env.example:
    - USE_REAL_FIREBASE=true
    - FIREBASE_CREDENTIALS=./serviceAccountKey.json
    - TESTING=false
    
    Add documentation comments explaining each variable.
    
    Update .gitignore to ensure credentials never committed.
  </action>
  <verify>
    1. Verify .env.example shows production config
    2. Verify .env has USE_REAL_FIREBASE=true
    3. Verify serviceAccountKey.json in .gitignore
  </verify>
  <done>Environment configuration updated</done>
</task>

<task type="auto">
  <name>Task 4: Create API authentication documentation</name>
  <files>documentations/api-authentication.md</files>
  <action>
    Create documentation explaining the authentication flow:
    
    - Overview of Firebase Authentication
    - Authentication flow (frontend to backend)
    - Endpoint documentation (/api/auth/sync, /api/admin/users)
    - User roles and permissions
    - Error responses
    - Token refresh handling
    - Security notes
    
    Include code examples for frontend integration.
  </action>
  <verify>
    1. Check document exists
    2. Verify auth flow explained
    3. Verify endpoints documented
  </verify>
  <done>API authentication documentation created</done>
</task>

<task type="auto">
  <name>Task 5: Final validation</name>
  <files>api/auth.py, api/auth_sync.py, api/users.py</files>
  <action>
    Perform final validation:
    
    1. Run Python syntax check on all auth files
    2. Verify all imports work
    3. Run auth tests
    4. Check for unused code or imports
    5. Verify docstrings present
    6. Ensure consistent formatting
    
    Fix any issues found.
  </action>
  <verify>
    1. Syntax checks pass
    2. Imports work
    3. Tests pass
  </verify>
  <done>Final validation complete</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Mock login endpoint removed
- [ ] Mock token verification isolated to TESTING=true only
- [ ] .env and .env.example updated
- [ ] API authentication documentation created
- [ ] Final validation passed
</verification>

<success_criteria>
- All tasks completed
- Mock authentication removed from production paths
- Backend uses real Firebase authentication
- Environment configured for production
- Code is clean and production-ready
</success_criteria>

<output>
After completion, create 04-03-SUMMARY.md
</output>
