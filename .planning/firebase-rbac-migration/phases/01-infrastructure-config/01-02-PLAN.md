---
phase: 01-infrastructure-config
type: execute
---

<objective>
Update backend configuration to support both mock and real Firebase Firestore with environment-based switching.

Purpose: Enable the application to switch between mock authentication (for local development) and real Firebase (for production) via environment variables. This provides flexibility and a safe rollback path.
Output: Updated `api/config.py` with conditional Firebase initialization and environment-based database switching.
</objective>

<execution_context>
@~/.Opencode/skills/create-plans/workflows/execute-phase.md
@~/.Opencode/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/firebase-rbac-migration/BRIEF.md
@.planning/firebase-rbac-migration/ROADMAP.md
@FIREBASE_RBAC_MIGRATION_PLAN.md
@api/config.py
@api/mock_firestore.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add firebase-admin dependency</name>
  <files>requirements.txt</files>
  <action>
    Add `firebase-admin` to requirements.txt. Check if it's already there first.
    If not present, add it:
    firebase-admin>=6.0.0
    
    This is the official Python Admin SDK for Firebase. It provides:
    - Firestore client
    - Authentication token verification
    - App Check token verification
    - Custom claims management
    
    Keep the existing mock_firestore.py - we need it for development.
  </action>
  <verify>
    Read requirements.txt and confirm firebase-admin is listed
  </verify>
  <done>firebase-admin added to requirements.txt with version constraint >=6.0.0</done>
</task>

<task type="auto">
  <name>Task 2: Update api/config.py with Firebase initialization</name>
  <files>api/config.py</files>
  <action>
    Read the current api/config.py to understand its structure.
    
    Then modify it to add:
    1. Import firebase_admin at the top:
       import firebase_admin
       from firebase_admin import credentials
    
    2. Add a function to initialize Firebase Admin SDK:
       def init_firebase():
           if not firebase_admin._apps:  # Only initialize once
               if os.getenv('USE_REAL_FIREBASE', 'false').lower() == 'true':
                   cred_path = os.getenv('FIREBASE_CREDENTIALS', './serviceAccountKey.json')
                   if os.path.exists(cred_path):
                       cred = credentials.Certificate(cred_path)
                       firebase_admin.initialize_app(cred)
                       print("Firebase initialized with service account")
                   else:
                       raise FileNotFoundError(f"Firebase credentials not found: {cred_path}")
               else:
                   # Initialize without credentials for local development
                   # This won't work for Firestore but is needed for App Check tests
                   firebase_admin.initialize_app()
    
    3. Update get_db() to support real Firestore:
       from firebase_admin import firestore
       
       def get_db():
           if os.getenv('USE_REAL_FIREBASE', 'false').lower() == 'true':
               init_firebase()
               return firestore.client()
           else:
               from mock_firestore import get_mock_db
               return get_mock_db()
    
    4. Add get_auth() function for authentication:
       from firebase_admin import auth
       
       def get_auth():
           init_firebase()
           return auth
    
    Important: Ensure backward compatibility - the mock Firestore must still work when USE_REAL_FIREBASE=false.
    Do NOT break existing functionality.
  </action>
  <verify>
    1. Read api/config.py to verify the changes
    2. Check that init_firebase() function exists
    3. Check that get_db() has conditional logic
    4. Check that get_auth() function exists
  </verify>
  <done>api/config.py updated with Firebase initialization, get_db() conditional, and get_auth() function</done>
</task>

<task type="auto">
  <name>Task 3: Create .env file with Firebase configuration</name>
  <files>.env</files>
  <action>
    Create or update the .env file in the project root with Firebase configuration.
    
    Add these variables:
    
    # Firebase Configuration
    USE_REAL_FIREBASE=false
    FIREBASE_CREDENTIALS=./serviceAccountKey.json
    
    # IMPORTANT:
    # - Set USE_REAL_FIREBASE=true to use real Firebase Firestore and Auth
    # - Set USE_REAL_FIREBASE=false to use mock database (for local development)
    # - NEVER commit serviceAccountKey.json to git
    
    If .env already exists with other variables, preserve them and just add the Firebase section.
    
    Note: The serviceAccountKey.json must exist (from 01-01-PLAN.md) but is gitignored.
  </action>
  <verify>
    Read .env file and verify Firebase configuration variables are present.
    Verify USE_REAL_FIREBASE is set to 'false' (keep using mock for now).
  </verify>
  <done>.env file created with Firebase configuration, defaulting to mock mode</done>
</task>

<task type="auto">
  <name>Task 4: Add python-dotenv for environment loading</name>
  <files>requirements.txt, api/config.py</files>
  <action>
    Check if python-dotenv is already in requirements.txt. If not, add it:
    python-dotenv>=0.19.0
    
    Then update api/config.py to load .env file at the top:
    
    from dotenv import load_dotenv
    
    # Load environment variables from .env file
    load_dotenv()
    
    This ensures environment variables are available throughout the application.
    Place this BEFORE any other imports that might need env vars.
  </action>
  <verify>
    1. Read requirements.txt to confirm python-dotenv is present
    2. Read api/config.py to confirm load_dotenv() is called at the top
  </verify>
  <done>python-dotenv added and load_dotenv() called at the start of api/config.py</done>
</task>

<task type="auto">
  <name>Task 5: Create configuration validation script</name>
  <files>tools/verify_firebase_config.py</files>
  <action>
    Create a script to verify Firebase configuration without starting the full server.
    
    The script should:
    1. Load environment variables
    2. Check if USE_REAL_FIREBASE is set
    3. If true, verify serviceAccountKey.json exists
    4. Attempt to initialize Firebase Admin SDK
    5. Try to connect to Firestore (list collections)
    6. Print success or detailed error message
    
    Usage: python tools/verify_firebase_config.py
    
    This helps catch configuration issues early before running the full application.
    
    Include error handling for:
    - Missing service account file
    - Invalid JSON in service account
    - Network connectivity issues
    - Missing required environment variables
  </action>
  <verify>
    1. Read tools/verify_firebase_config.py to verify it exists and has proper structure
    2. Run: USE_REAL_FIREBASE=false python tools/verify_firebase_config.py
       Should indicate mock mode is being used
  </verify>
  <done>Configuration validation script created at tools/verify_firebase_config.py</done>
</task>

<task type="auto">
  <name>Task 6: Test configuration with mock mode</name>
  <files>api/config.py, api/mock_firestore.py</files>
  <action>
    Test that the updated configuration works with mock mode (USE_REAL_FIREBASE=false).
    
    Create a quick test script or run a Python command to verify:
    
    from api.config import get_db
    db = get_db()
    print(f"DB client type: {type(db)}")
    # Should show MockFirestoreClient type
    
    Ensure:
    - MockFirestoreClient is returned when USE_REAL_FIREBASE=false
    - No Firebase initialization errors occur in mock mode
    - Existing API endpoints still work
    
    If tests fail, fix the configuration issues before proceeding.
  </action>
  <verify>
    Run: cd api && python -c "from config import get_db; db = get_db(); print(type(db).__name__)"
    Should output: MockFirestoreClient (or similar)
  </verify>
  <done>Configuration works correctly in mock mode - get_db() returns MockFirestoreClient</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pip install -r requirements.txt` succeeds (firebase-admin, python-dotenv installed)
- [ ] `python tools/verify_firebase_config.py` runs without errors in mock mode
- [ ] `python -c "from api.config import get_db; get_db()"` returns MockFirestoreClient when USE_REAL_FIREBASE=false
- [ ] .env file exists with Firebase configuration
- [ ] api/config.py has init_firebase(), get_db() with conditional logic, and get_auth() function
- [ ] load_dotenv() is called at the top of api/config.py
- [ ] Backward compatibility maintained - existing functionality works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Backend can switch between mock and real Firebase via .env
- Configuration validation script works
- No breaking changes to existing functionality
- Dependencies installed (firebase-admin, python-dotenv)
</success_criteria>

<output>
After completion, create `.planning/firebase-rbac-migration/phases/01-infrastructure-config/01-02-SUMMARY.md`
</output>
