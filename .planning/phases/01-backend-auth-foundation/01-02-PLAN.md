---
phase: 01-backend-auth-foundation
plan: 01-02
type: execute
---

<objective>
Create the core authentication module with token verification and FastAPI dependencies.

Purpose: Provide role-based endpoint protection for all backend APIs.
Output: `api/auth.py` with UserInfo model, token verification, and FastAPI dependencies.
</objective>

<execution_context>
@~/.Opencode/skills/create-plans/workflows/execute-phase.md
@~/.Opencode/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@AUTHENTICATION_DOCUMENTATION.md
@api/mock_firestore.py
@api/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth.py with UserInfo model and token verification</name>
  <files>api/auth.py</files>
  <action>
Create `api/auth.py` with:

1. **Imports:**
   ```python
   from fastapi import APIRouter, Depends, HTTPException, Header, status
   from pydantic import BaseModel
   from typing import Optional, List
   ```

2. **UserInfo Pydantic model:**
   ```python
   class UserInfo(BaseModel):
       uid: str
       email: str
       display_name: Optional[str] = None
       role: str  # "admin" | "staff" | "student"
       department_id: Optional[str] = None
       status: str = "active"
   ```

3. **LoginRequest model:**
   ```python
   class LoginRequest(BaseModel):
       email: str
       password: str
   ```

4. **verify_firebase_token(token: str) -> dict:**
   - If token starts with "mock-token-", parse format: `mock-token-{role}-{uid}`
   - Extract role from parts[2], uid from "-".join(parts[3:])
   - Return dict with uid, email, name, role
   - Else: Raise HTTPException 401 (real Firebase not implemented yet)

5. **get_db() helper:**
   - Import from config or create MockFirestoreClient
   - Return database client

Include proper file header following AGENTS.md guidelines.

AVOID: Importing firebase_admin directly at module level.
WHY: Causes import errors when Firebase not configured.
  </action>
  <verify>python -c "from api.auth import UserInfo, LoginRequest, verify_firebase_token; print('Import successful')"</verify>
  <done>UserInfo, LoginRequest, and verify_firebase_token import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add authentication dependencies</name>
  <files>api/auth.py</files>
  <action>
Add FastAPI dependencies to `api/auth.py`:

1. **get_current_user(authorization: str = Header(None)) -> UserInfo:**
   - Extract token from "Bearer {token}" header
   - Call verify_firebase_token(token)
   - Look up user in Firestore `users` collection by uid
   - Check user status is not "disabled"
   - Return UserInfo with all fields populated
   - Raise 401 if no token or invalid
   - Raise 403 if user disabled or not found

2. **require_admin(user: UserInfo = Depends(get_current_user)) -> UserInfo:**
   - Check user.role == "admin"
   - Raise 403 if not admin
   - Return user

3. **require_staff(user: UserInfo = Depends(get_current_user)) -> UserInfo:**
   - Check user.role in ("admin", "staff")
   - Raise 403 if not staff or admin
   - Return user

4. **require_role(*allowed_roles: str) factory:**
   ```python
   def require_role(*allowed_roles: str):
       async def role_checker(user: UserInfo = Depends(get_current_user)) -> UserInfo:
           if user.role not in allowed_roles:
               raise HTTPException(
                   status_code=status.HTTP_403_FORBIDDEN,
                   detail=f"Required role: {' or '.join(allowed_roles)}"
               )
           return user
       return role_checker
   ```

5. **require_department_access(department_id: str) factory:**
   - Admins always have access
   - Others must match department_id
   - Raise 403 if no access

AVOID: Making get_current_user async without await.
WHY: Causes runtime warnings; use sync function with sync Firestore.
  </action>
  <verify>python -c "from api.auth import get_current_user, require_admin, require_staff, require_role, require_department_access; print('Dependencies imported')"</verify>
  <done>All authentication dependencies import without errors</done>
</task>

<task type="auto">
  <name>Task 3: Add login endpoint router</name>
  <files>api/auth.py</files>
  <action>
Add login endpoint to `api/auth.py`:

1. **Create router:**
   ```python
   router = APIRouter(prefix="/api/auth", tags=["auth"])
   ```

2. **POST /api/auth/login endpoint:**
   ```python
   @router.post("/login")
   async def login(creds: LoginRequest):
       """Mock login endpoint - validates email/password against Firestore users."""
       db = get_db()
       
       # Query user by email
       users_ref = db.collection("users")
       query = users_ref.where("email", "==", creds.email)
       results = list(query.stream())
       
       if not results:
           raise HTTPException(
               status_code=status.HTTP_401_UNAUTHORIZED,
               detail="Invalid email or password"
           )
       
       user_doc = results[0]
       user_data = user_doc.to_dict()
       
       # Check if disabled
       if user_data.get("status") == "disabled":
           raise HTTPException(
               status_code=status.HTTP_403_FORBIDDEN,
               detail="Account has been disabled"
           )
       
       # Validate password
       stored_password = user_data.get("password", "")
       if stored_password != creds.password:
           raise HTTPException(
               status_code=status.HTTP_401_UNAUTHORIZED,
               detail="Invalid email or password"
           )
       
       # Generate mock token
       uid = user_doc.id
       role = user_data.get("role", "student")
       token = f"mock-token-{role}-{uid}"
       
       return {
           "token": token,
           "user": {
               "id": uid,
               "email": user_data.get("email"),
               "displayName": user_data.get("displayName"),
               "role": role,
               "departmentId": user_data.get("departmentId"),
               "status": user_data.get("status", "active")
           }
       }
   ```

AVOID: Hashing passwords in mock implementation.
WHY: Mock auth is for development only; production will use Firebase Auth.
  </action>
  <verify>python -c "from api.auth import router; print(f'Router prefix: {router.prefix}')"</verify>
  <done>Auth router created with /api/auth prefix</done>
</task>

<task type="auto">
  <name>Task 4: Update config.py to support mock database toggle</name>
  <files>api/config.py</files>
  <action>
Update `api/config.py` to:

1. Add environment variable check:
   ```python
   import os
   USE_MOCK_DB = os.environ.get("USE_REAL_FIREBASE", "false").lower() != "true"
   ```

2. Create `get_db()` function:
   ```python
   _db_instance = None
   
   def get_db():
       global _db_instance
       if _db_instance is None:
           if USE_MOCK_DB:
               from mock_firestore import MockFirestoreClient
               _db_instance = MockFirestoreClient()
           else:
               # Real Firebase initialization (existing code)
               _db_instance = db  # existing Firestore client
       return _db_instance
   ```

3. Export `get_db` and `USE_MOCK_DB`

AVOID: Breaking existing `db` variable usage.
WHY: Other modules may still import `db` directly.
  </action>
  <verify>python -c "from api.config import get_db, USE_MOCK_DB; print(f'USE_MOCK_DB: {USE_MOCK_DB}')"</verify>
  <done>config.py exports get_db() and USE_MOCK_DB</done>
</task>

<task type="auto">
  <name>Task 5: Mount auth router in main.py</name>
  <files>api/main.py</files>
  <action>
Update `api/main.py` to include the auth router:

1. Add import near other router imports:
   ```python
   from auth import router as auth_router
   ```

2. Include router after other router inclusions:
   ```python
   app.include_router(auth_router)
   ```

AVOID: Adding import at very top of file.
WHY: Keep with other router imports for consistency.
  </action>
  <verify>python -c "from api.main import app; routes = [r.path for r in app.routes]; print('/api/auth/login' in str(routes) or 'auth' in str(routes))"</verify>
  <done>Auth router mounted in main.py</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from api.auth import UserInfo, get_current_user, require_admin, router"` succeeds
- [ ] `python -c "from api.config import get_db, USE_MOCK_DB"` succeeds
- [ ] Auth router has `/login` endpoint
- [ ] get_current_user parses Bearer token correctly
- [ ] require_admin blocks non-admin users
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- UserInfo model has all required fields
- Token verification supports mock token format
- FastAPI dependencies chain correctly
- Login endpoint validates credentials and returns token
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-auth-foundation/01-02-SUMMARY.md`
</output>
