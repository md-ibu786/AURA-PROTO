---
phase: 01-backend-auth-foundation
plan: 01-01
type: execute
---

<objective>
Create the MockFirestoreClient infrastructure for local development without Firebase credentials.

Purpose: Enable authentication development and testing without requiring real Firebase setup.
Output: `api/mock_firestore.py` with complete mock Firestore and Auth implementations.
</objective>

<execution_context>
@~/.Opencode/skills/create-plans/workflows/execute-phase.md
@~/.Opencode/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@AUTHENTICATION_DOCUMENTATION.md
@api/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock_firestore.py with core classes</name>
  <files>api/mock_firestore.py</files>
  <action>
Create `api/mock_firestore.py` with the following classes:

1. **MOCK_DB** - Global dictionary storing all mock data by collection name

2. **MockDocumentSnapshot** - Wrapper for document data:
   - `exists` property returning bool
   - `id` property returning document ID
   - `to_dict()` method returning data dictionary
   - `get(field)` method for field access

3. **MockDocumentReference** - Document reference with:
   - `get()` returning MockDocumentSnapshot
   - `set(data, merge=False)` storing data in MOCK_DB
   - `update(data)` merging data
   - `delete()` removing document
   - `id` property

4. **MockQuery** - Query builder with:
   - `where(field, op, value)` filtering (support ==, !=, in)
   - `limit(n)` limiting results
   - `stream()` yielding MockDocumentSnapshot objects
   - `get()` returning list of snapshots

5. **MockCollection** - Collection reference with:
   - `document(doc_id=None)` returning MockDocumentReference
   - `where(field, op, value)` returning MockQuery
   - `stream()` yielding all documents
   - `add(data)` creating document with auto-ID

6. **MockFirestoreClient** - Main client with:
   - `collection(name)` returning MockCollection
   - `_get_or_create_collection(name)` internal helper

7. **MockAuth** - Mock Firebase Auth with:
   - `verify_id_token(token, clock_skew_seconds=10)` parsing mock tokens
   - Token format: `mock-token-{role}-{uid}`

Include proper file header following AGENTS.md guidelines.

AVOID: Complex async implementation - keep sync for simplicity.
WHY: Mock is for local dev only; async adds unnecessary complexity.
  </action>
  <verify>python -c "from api.mock_firestore import MockFirestoreClient, MockAuth; print('Import successful')"</verify>
  <done>MockFirestoreClient and MockAuth classes import without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add seed user data initialization</name>
  <files>api/mock_firestore.py</files>
  <action>
Add a `_seed_initial_data()` function called during MockFirestoreClient initialization that populates MOCK_DB with test users:

```python
def _seed_initial_data():
    """Pre-populate mock database with test users."""
    if "users" not in MOCK_DB:
        MOCK_DB["users"] = {}
    
    # Only seed if empty
    if MOCK_DB["users"]:
        return
    
    seed_users = [
        {
            "id": "mock-admin-001",
            "email": "admin@test.com",
            "displayName": "Test Admin",
            "role": "admin",
            "departmentId": None,
            "subjectIds": None,
            "status": "active",
            "password": "Admin123!",
            "createdAt": "2026-01-01T00:00:00.000Z",
            "updatedAt": "2026-01-01T00:00:00.000Z"
        },
        {
            "id": "mock-staff-001",
            "email": "staff@test.com",
            "displayName": "Test Staff",
            "role": "staff",
            "departmentId": "dept-cs-001",
            "subjectIds": ["subject-001"],
            "status": "active",
            "password": "Staff123!",
            "createdAt": "2026-01-01T00:00:00.000Z",
            "updatedAt": "2026-01-01T00:00:00.000Z"
        },
        {
            "id": "mock-student-001",
            "email": "student@test.com",
            "displayName": "Test Student",
            "role": "student",
            "departmentId": "dept-cs-001",
            "subjectIds": None,
            "status": "active",
            "password": "Student123!",
            "createdAt": "2026-01-01T00:00:00.000Z",
            "updatedAt": "2026-01-01T00:00:00.000Z"
        }
    ]
    
    for user in seed_users:
        MOCK_DB["users"][user["id"]] = user
```

Call this in MockFirestoreClient.__init__().

AVOID: Seeding on every method call.
WHY: Would reset data unexpectedly during tests.
  </action>
  <verify>python -c "from api.mock_firestore import MockFirestoreClient; db = MockFirestoreClient(); users = list(db.collection('users').stream()); print(f'Seeded {len(users)} users')"</verify>
  <done>MockFirestoreClient seeds 3 test users on initialization</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for mock_firestore</name>
  <files>api/test_mock_firestore.py</files>
  <action>
Create `api/test_mock_firestore.py` with pytest tests covering:

1. **test_document_set_and_get** - Set document, get it back, verify data
2. **test_document_update** - Update existing document, verify merge
3. **test_document_delete** - Delete document, verify `exists` is False
4. **test_query_where_equals** - Query with `where("field", "==", value)`
5. **test_query_where_in** - Query with `where("field", "in", [values])`
6. **test_collection_stream** - Stream all documents in collection
7. **test_seed_users_exist** - Verify 3 seed users created
8. **test_mock_auth_verify_token** - Parse mock token format

Include proper file header following AGENTS.md guidelines.
  </action>
  <verify>cd api && python -m pytest test_mock_firestore.py -v</verify>
  <done>All 8 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from api.mock_firestore import MockFirestoreClient, MockAuth"` succeeds
- [ ] `cd api && python -m pytest test_mock_firestore.py -v` passes all tests
- [ ] MockFirestoreClient seeds 3 users automatically
- [ ] MockAuth.verify_id_token parses `mock-token-admin-uid123` correctly
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No import errors
- Mock database supports CRUD and query operations
- Seed data includes admin, staff, and student users
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-auth-foundation/01-01-SUMMARY.md`
</output>
