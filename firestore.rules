rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPER FUNCTIONS ==========

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get current user's UID
    function currentUserId() {
      return request.auth.uid;
    }

    function hasStatusClaim() {
      return 'status' in request.auth.token;
    }

    // Check if authenticated user is active.
    // Prefer custom claim when present; otherwise fall back to Firestore user status.
    function isActiveUser() {
      return isAuthenticated()
          && ((hasStatusClaim() && request.auth.token.status == 'active')
              || (!hasStatusClaim()
                  && userDoc().data != null
                  && userDoc().data.status == 'active'));
    }

    // Check Custom Claims for global role
    function hasRole(role) {
      return isActiveUser() && request.auth.token.role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isStaff() {
      return hasRole('staff');
    }

    function isStudent() {
      return hasRole('student');
    }

    // Get user document from Firestore (for granular permissions)
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(currentUserId()));
    }

    function userData() {
      return userDoc().data;
    }

    // Check if user is in a specific department (Firestore lookup)
    function isInDepartment(departmentId) {
      return isActiveUser()
          && userDoc().data != null
          && userDoc().data.departmentId == departmentId;
    }

    // Check if user has access to a specific subject (Firestore lookup)
    function hasSubjectAccess(subjectId) {
      return isActiveUser()
          && userDoc().data != null
          && userDoc().data.subjectIds is list
          && subjectId in userDoc().data.subjectIds;
    }

    // Check if document is in user's department (for read operations)
    function isDocumentInMyDepartment(data) {
      return isActiveUser()
          && data != null
          && userDoc().data != null
          && data.departmentId == userDoc().data.departmentId;
    }

    // ========== VALIDATION FUNCTIONS ==========

    function hasValidName(data) {
      return data.name is string
          && data.name.size() > 0
          && data.name.size() < 200;
    }

    function hasValidCode(data) {
      return !('code' in data)
          || (data.code is string && data.code.size() < 50);
    }

    function hasValidSemesterNumber(data) {
      return ('semester_number' in data && data.semester_number is int)
          || ('semesterNumber' in data && data.semesterNumber is int);
    }

    function hasValidModuleNumber(data) {
      return ('module_number' in data && data.module_number is int)
          || ('moduleNumber' in data && data.moduleNumber is int);
    }

    function isValidDepartment(data) {
      return hasValidName(data) && hasValidCode(data);
    }

    function isValidSemester(data) {
      return hasValidName(data) && hasValidSemesterNumber(data);
    }

    function isValidSubject(data) {
      return hasValidName(data) && hasValidCode(data);
    }

    function isValidModule(data) {
      return hasValidName(data) && hasValidModuleNumber(data);
    }

    function isValidNote(note) {
      return note.keys().hasAll(['title', 'module_id', 'created_at'])
          && note.title is string
          && note.module_id is string
          && note.created_at is string
          && (!('pdf_url' in note) || note.pdf_url is string)
          && (!('content' in note) || note.content is string)
          && (!('subjectId' in note) || note.subjectId is string)
          && (!('departmentId' in note) || note.departmentId is string);
    }

    function isValidUser(user) {
      return user.keys().hasAll(['uid', 'email', 'role', 'status', 'createdAt', 'updatedAt', '_v'])
          && user.uid is string
          && user.email is string
          && user.role in ['admin', 'staff', 'student']
          && user.status in ['active', 'disabled']
          && user.createdAt is string
          && user.updatedAt is string
          && user._v is int
          && (!('displayName' in user) || user.displayName is string)
          && (!('departmentId' in user) || user.departmentId is string || user.departmentId == null)
          && (!('subjectIds' in user) || user.subjectIds is list);
    }

    function hasValidUserRoleFields(user) {
      return (user.role == 'student'
          && user.departmentId is string
          && user.subjectIds is list
          && user.subjectIds.size() == 0)
          || (user.role == 'staff'
          && user.subjectIds is list
          && user.subjectIds.size() > 0)
          || (user.role == 'admin');
    }

    // ========== DEFAULT DENY ==========

    // Deny all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // ========== USERS COLLECTION ==========

    match /users/{userId} {
      // Users can read their own document, admins can read all
      allow get: if isAdmin() || (isAuthenticated() && currentUserId() == userId);

      // Admins can list all users
      allow list: if isAdmin();

      // Only admins can create/update/delete users
      allow create: if isAdmin()
          && isValidUser(request.resource.data)
          && hasValidUserRoleFields(request.resource.data)
          && request.resource.data.uid == userId;

      allow update: if isAdmin()
          && isValidUser(request.resource.data)
          && hasValidUserRoleFields(request.resource.data)
          && request.resource.data.uid == userId;

      allow delete: if isAdmin();
    }

    // ========== DEPARTMENTS ==========

    match /departments/{departmentId} {
      // Anyone authenticated can read departments
      allow read: if isActiveUser();

      // Only admins can modify departments
      allow create, update: if isAdmin() && isValidDepartment(request.resource.data);
      allow delete: if isAdmin();

      // ========== SEMESTERS ==========

      match /semesters/{semesterId} {
        // Anyone authenticated can read semesters
        allow read: if isActiveUser();

        // Only admins can modify semesters
        allow create, update: if isAdmin() && isValidSemester(request.resource.data);
        allow delete: if isAdmin();

        // ========== SUBJECTS ==========

        match /subjects/{subjectId} {
          // Anyone authenticated can read subjects
          allow read: if isActiveUser();

          // Only admins can create/delete subjects
          allow create: if isAdmin() && isValidSubject(request.resource.data);
          allow delete: if isAdmin();

          // Admins can update any subject
          // Staff can update subjects they have access to
          allow update: if (isAdmin() || (isStaff() && hasSubjectAccess(subjectId)))
              && isValidSubject(request.resource.data);

          // ========== MODULES ==========

          match /modules/{moduleId} {
            // Anyone authenticated can read modules
            allow read: if isActiveUser();

            // Only admins can create/delete modules
            allow create: if isAdmin() && isValidModule(request.resource.data);
            allow delete: if isAdmin();

            // Staff can update modules in subjects they have access to
            allow update: if (isAdmin() || (isStaff() && hasSubjectAccess(subjectId)))
                && isValidModule(request.resource.data);

            // ========== NOTES ==========

            match /notes/{noteId} {
              // Students can only read notes in their department
              // Staff can read notes in subjects they have access to
              // Admins can read all notes
              allow read: if isAdmin()
                  || (isStaff() && hasSubjectAccess(subjectId))
                  || (isStudent() && isInDepartment(departmentId));

              // Only admins and assigned staff can create notes
              allow create: if (isAdmin() || (isStaff() && hasSubjectAccess(subjectId)))
                  && isValidNote(request.resource.data)
                  && request.resource.data.module_id == moduleId
                  && (!('subjectId' in request.resource.data)
                      || request.resource.data.subjectId == subjectId)
                  && (!('departmentId' in request.resource.data)
                      || request.resource.data.departmentId == departmentId);

              // Only admins and assigned staff can update notes
              allow update: if (isAdmin() || (isStaff() && hasSubjectAccess(subjectId)))
                  && isValidNote(request.resource.data)
                  && request.resource.data.module_id == moduleId
                  && resource.data.module_id == moduleId
                  && (!('subjectId' in request.resource.data)
                      || request.resource.data.subjectId == subjectId)
                  && (!('departmentId' in request.resource.data)
                      || request.resource.data.departmentId == departmentId)
                  && (!('subjectId' in resource.data)
                      || resource.data.subjectId == subjectId)
                  && (!('departmentId' in resource.data)
                      || resource.data.departmentId == departmentId);

              // Only admins can delete notes
              allow delete: if isAdmin();
            }
          }
        }
      }
    }
  }
}
